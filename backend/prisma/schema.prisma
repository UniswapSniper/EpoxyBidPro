// EpoxyBidPro — Prisma Schema
// Database: PostgreSQL 16
// Generator: Prisma Client (TypeScript)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum Plan {
  FREE_TRIAL
  SOLO
  TEAM
  ENTERPRISE
}

enum Role {
  OWNER
  ADMIN
  CREW
}

enum LeadStatus {
  NEW
  CONTACTED
  SITE_VISIT_SCHEDULED
  BID_SENT
  WON
  LOST
}

enum LeadSource {
  REFERRAL
  GOOGLE
  YELP
  FACEBOOK
  INSTAGRAM
  DOOR_HANGER
  TRADE_SHOW
  OTHER
}

enum ClientType {
  RESIDENTIAL
  COMMERCIAL
  MULTI_FAMILY
  INDUSTRIAL
}

enum QuoteStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  DECLINED
  EXPIRED
}

enum JobStatus {
  SCHEDULED
  IN_PROGRESS
  PUNCH_LIST
  COMPLETE
  INVOICED
  PAID
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  VOIDED
}

enum PaymentMethod {
  CARD
  ACH
  APPLE_PAY
  CHECK
  CASH
  OTHER
}

enum PhotoCategory {
  BEFORE
  DURING
  AFTER
  SURFACE_CONDITION
  DAMAGE
  MARKETING
  DOCUMENT
}

enum CoatingSystem {
  SINGLE_COAT_CLEAR
  TWO_COAT_FLAKE
  FULL_METALLIC
  QUARTZ
  POLYASPARTIC
  COMMERCIAL_GRADE
  CUSTOM
}

enum SurfaceCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum BidTier {
  GOOD
  BETTER
  BEST
}

// ─── Core Models ─────────────────────────────────────────────────────────────

model User {
  id              String   @id @default(uuid())
  appleId         String?  @unique
  email           String   @unique
  passwordHash    String?
  firstName       String
  lastName        String
  phone           String?
  avatarUrl       String?
  plan            Plan     @default(FREE_TRIAL)
  trialEndsAt     DateTime?
  stripeAccountId String?  // Stripe Connect account
  stripeCustomerId String?
  businessId      String   @unique
  business        Business @relation(fields: [businessId], references: [id])
  role            Role     @default(OWNER)
  fcmTokens       String[] // Firebase Cloud Messaging tokens
  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@map("users")
}

model Business {
  id              String   @id @default(uuid())
  name            String
  logoUrl         String?
  phone           String?
  email           String?
  website         String?
  address         String?
  city            String?
  state           String?
  zip             String?
  licenseNumber   String?
  taxRate         Float    @default(0)
  defaultMarkup   Float    @default(0.25)    // 25%
  defaultMargin   Float    @default(0.30)    // 30%
  laborRate       Float    @default(65.0)    // $/hr
  overheadRate    Float    @default(0.15)    // 15%
  wasteFactorStd  Float    @default(0.10)    // 10%
  wasteFactorCpx  Float    @default(0.15)    // 15%
  mobilizationFee Float    @default(0)
  minimumJobPrice Float    @default(500)
  brandColor      String   @default("#1E3A5F")
  accentColor     String   @default("#3B82F6")
  termsText       String?  @db.Text
  warrantyText    String?  @db.Text
  aboutText       String?  @db.Text
  quoteFooter     String?
  bidPrefix       String   @default("BID")
  nextBidNum      Int      @default(1001)
  quotePrefix     String   @default("Q")
  invoicePrefix   String   @default("INV")
  nextQuoteNum    Int      @default(1001)
  nextInvoiceNum  Int      @default(2001)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  users           User[]
  clients         Client[]
  leads           Lead[]
  crewMembers     CrewMember[]
  materials       Material[]
  templates       Template[]
  jobs            Job[]
  bids            Bid[]
  quotes          Quote[]
  invoices        Invoice[]
  subscription    Subscription?

  @@map("businesses")
}

// ─── Subscription ─────────────────────────────────────────────────────────────

model Subscription {
  id                  String    @id @default(uuid())
  businessId          String    @unique
  business            Business  @relation(fields: [businessId], references: [id])
  plan                Plan      @default(FREE_TRIAL)
  status              String    @default("active")   // active | canceled | past_due | trialing
  stripeSubscriptionId String?  @unique
  stripePriceId       String?
  stripeCustomerId    String?
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean   @default(false)
  trialEnd            DateTime?
  seatCount           Int       @default(1)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([businessId])
  @@map("subscriptions")
}

model Client {
  id           String     @id @default(uuid())
  businessId   String
  business     Business   @relation(fields: [businessId], references: [id])
  firstName    String
  lastName     String
  email        String?
  phone        String?
  company      String?
  type         ClientType @default(RESIDENTIAL)
  address      String?
  city         String?
  state        String?
  zip          String?
  latitude     Float?
  longitude    Float?
  notes        String?    @db.Text
  tags         String[]
  isVip        Boolean    @default(false)
  leadSource   LeadSource?
  totalRevenue Float      @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  leads        Lead[]
  bids         Bid[]
  measurements Measurement[]
  quotes       Quote[]
  jobs         Job[]
  invoices     Invoice[]
  photos       Photo[]
  activityLogs ActivityLog[]

  @@index([businessId])
  @@index([email])
  @@map("clients")
}

model Lead {
  id           String     @id @default(uuid())
  businessId   String
  business     Business   @relation(fields: [businessId], references: [id])
  clientId     String?
  client       Client?    @relation(fields: [clientId], references: [id])
  firstName    String
  lastName     String
  email        String?
  phone        String?
  address      String?
  city         String?
  state        String?
  zip          String?
  source       LeadSource @default(OTHER)
  status       LeadStatus @default(NEW)
  notes        String?    @db.Text
  lostReason   String?
  estimatedValue Float?
  followUpAt   DateTime?
  siteVisitAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([businessId, status])
  @@map("leads")
}

// ─── Scanning & Measurement ──────────────────────────────────────────────────

model Measurement {
  id            String   @id @default(uuid())
  jobId         String?
  job           Job?     @relation(fields: [jobId], references: [id])
  clientId      String?
  client        Client?  @relation(fields: [clientId], references: [id])
  name          String   @default("Floor Scan")
  totalSqFt     Float
  isLidar       Boolean  @default(true)
  scanDataJson  Json?    // Serialized ARMeshGeometry polygon points
  floorPlanUrl  String?  // S3 URL to floor plan image
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  areas         Area[]
  bids          Bid[]

  @@map("measurements")
}

model Area {
  id            String   @id @default(uuid())
  measurementId String
  measurement   Measurement @relation(fields: [measurementId], references: [id], onDelete: Cascade)
  label         String   // "Garage", "Basement", "Bay 1"
  sqFt          Float
  polygonJson   Json?    // 2D polygon vertices
  notes         String?
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lineItems     LineItem[]

  @@map("areas")
}

// ─── Bidding ─────────────────────────────────────────────────────────────────

model Bid {
  id               String           @id @default(uuid())
  businessId       String
  business         Business         @relation(fields: [businessId], references: [id])
  clientId         String?
  client           Client?          @relation(fields: [clientId], references: [id])
  measurementId    String?
  measurement      Measurement?     @relation(fields: [measurementId], references: [id])

  // Identity & status
  bidNumber        String           @default("")
  version          Int              @default(1)
  status           QuoteStatus      @default(DRAFT)

  // Bid details
  title            String           @default("New Bid")
  tier             BidTier          @default(BETTER)
  coatingSystem    CoatingSystem    @default(TWO_COAT_FLAKE)
  surfaceCondition SurfaceCondition @default(GOOD)
  totalSqFt        Float            @default(0)

  // Pricing
  materialCost     Float            @default(0)
  laborCost        Float            @default(0)
  overheadCost     Float            @default(0)
  mobilizationFee  Float            @default(0)
  subtotal         Float            @default(0)
  markup           Float            @default(0)
  taxAmount        Float            @default(0)
  totalPrice       Float            @default(0)
  profitMargin     Float            @default(0)
  estimatedHours   Float            @default(0)
  estimatedDays    Int              @default(1)
  wasteFactorUsed  Float            @default(0.10)

  // Proposal content
  executiveSummary String?          @db.Text
  scopeNotes       String?          @db.Text
  validUntil       DateTime?
  notes            String?          @db.Text

  // AI
  aiSuggestions    Json?
  aiRiskFlags      String[]
  aiUpsells        String[]

  // PDF & delivery
  pdfUrl           String?
  pdfGeneratedAt   DateTime?
  sentAt           DateTime?
  viewedAt         DateTime?
  signedAt         DateTime?
  declinedAt       DateTime?
  declinedReason   String?

  // Template
  templateId       String?
  template         Template?        @relation(fields: [templateId], references: [id])

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  lineItems        LineItem[]
  signature        BidSignature?
  job              Job?
  quotes           Quote[]          // legacy relation — kept for backward compat

  @@index([businessId])
  @@index([businessId, status])
  @@map("bids")
}

model BidSignature {
  id          String   @id @default(uuid())
  bidId       String   @unique
  bid         Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  signerName  String
  signerEmail String?
  signerIp    String?
  signedAt    DateTime @default(now())
  dataUrl     String   @db.Text  // Base64 PNG or S3 URL

  @@map("bid_signatures")
}


model LineItem {
  id          String   @id @default(uuid())
  bidId       String
  bid         Bid      @relation(fields: [bidId], references: [id], onDelete: Cascade)
  areaId      String?
  area        Area?    @relation(fields: [areaId], references: [id])
  category    String   // "Material", "Labor", "Prep", "Overhead", "Mobilization"
  description String
  quantity    Float    @default(1)
  unit        String   @default("sqft") // sqft, gal, hr, ea
  unitCost    Float    @default(0)
  totalCost   Float    @default(0)
  markup      Float    @default(0)
  totalPrice  Float    @default(0)
  materialId  String?
  material    Material? @relation(fields: [materialId], references: [id])
  order       Int      @default(0)
  isVisible   Boolean  @default(true) // Show/hide on proposal
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoiceLineItems InvoiceLineItem[]

  @@map("line_items")
}

// ─── Quotes / Proposals ──────────────────────────────────────────────────────

model Quote {
  id              String      @id @default(uuid())
  businessId      String
  business        Business    @relation(fields: [businessId], references: [id])
  clientId        String
  client          Client      @relation(fields: [clientId], references: [id])
  bidId           String
  bid             Bid         @relation(fields: [bidId], references: [id])
  quoteNumber     String
  version         Int         @default(1)
  status          QuoteStatus @default(DRAFT)
  title           String
  executiveSummary String?    @db.Text
  scopeNotes      String?     @db.Text
  validUntil      DateTime
  pdfUrl          String?
  sentAt          DateTime?
  viewedAt        DateTime?
  signedAt        DateTime?
  declinedAt      DateTime?
  declinedReason  String?
  signatureUrl    String?
  signatureIp     String?
  templateId      String?
  template        Template?   @relation(fields: [templateId], references: [id])
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  job             Job?
  signature       Signature?

  @@index([businessId, status])
  @@map("quotes")
}

model Signature {
  id          String   @id @default(uuid())
  quoteId     String   @unique
  quote       Quote    @relation(fields: [quoteId], references: [id])
  signerName  String
  signerEmail String?
  signerIp    String?
  signedAt    DateTime @default(now())
  dataUrl     String   @db.Text // Base64 signature image or S3 URL

  @@map("signatures")
}

// ─── Jobs ────────────────────────────────────────────────────────────────────

model Job {
  id            String    @id @default(uuid())
  businessId    String
  business      Business  @relation(fields: [businessId], references: [id])
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id])
  quoteId       String?   @unique
  quote         Quote?    @relation(fields: [quoteId], references: [id])
  bidId         String?   @unique
  bid           Bid?      @relation(fields: [bidId], references: [id])
  title         String
  status        JobStatus @default(SCHEDULED)
  scheduledDate DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  address       String?
  city          String?
  state         String?
  zip           String?
  latitude      Float?
  longitude     Float?
  totalSqFt     Float     @default(0)
  coatingSystem CoatingSystem?
  notes         String?   @db.Text
  fieldNotes    String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  crewAssignments CrewAssignment[]
  stages          JobStage[]
  measurements    Measurement[]
  photos          Photo[]
  documents       Document[]
  invoice         Invoice?
  timeEntries     TimeEntry[]

  @@index([businessId, status])
  @@index([scheduledDate])
  @@map("jobs")
}

model JobStage {
  id          String   @id @default(uuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  name        String   // "Surface Prep", "Primer", "Base Coat", "Broadcast", "Topcoat", "Final Inspection"
  description String?
  isComplete  Boolean  @default(false)
  completedAt DateTime?
  completedBy String?  // CrewMember id
  notes       String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  @@map("job_stages")
}

// ─── Crew ────────────────────────────────────────────────────────────────────

model CrewMember {
  id          String   @id @default(uuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id])
  firstName   String
  lastName    String
  email       String?
  phone       String?
  role        String   @default("Crew")
  hourlyRate  Float    @default(0)
  isActive    Boolean  @default(true)
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments CrewAssignment[]
  timeEntries TimeEntry[]

  @@index([businessId])
  @@map("crew_members")
}

model CrewAssignment {
  id           String     @id @default(uuid())
  jobId        String
  job          Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  crewMemberId String
  crewMember   CrewMember @relation(fields: [crewMemberId], references: [id])
  assignedAt   DateTime   @default(now())
  role         String?    // Lead, Helper, etc.

  @@unique([jobId, crewMemberId])
  @@map("crew_assignments")
}

model TimeEntry {
  id           String     @id @default(uuid())
  jobId        String
  job          Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  crewMemberId String
  crewMember   CrewMember @relation(fields: [crewMemberId], references: [id])
  clockIn      DateTime
  clockOut     DateTime?
  hoursWorked  Float?
  notes        String?
  createdAt    DateTime   @default(now())

  @@index([jobId])
  @@map("time_entries")
}

// ─── Invoicing & Payments ─────────────────────────────────────────────────────

model Invoice {
  id             String        @id @default(uuid())
  businessId     String
  business       Business      @relation(fields: [businessId], references: [id])
  clientId       String
  client         Client        @relation(fields: [clientId], references: [id])
  jobId          String?       @unique
  job            Job?          @relation(fields: [jobId], references: [id])
  invoiceNumber  String
  status         InvoiceStatus @default(DRAFT)
  subtotal       Float         @default(0)
  taxRate        Float         @default(0)
  taxAmount      Float         @default(0)
  discountAmount Float         @default(0)
  totalAmount    Float         @default(0)
  amountPaid     Float         @default(0)
  amountDue      Float         @default(0)
  dueDate        DateTime?
  sentAt         DateTime?
  paidAt         DateTime?
  pdfUrl         String?
  notes          String?       @db.Text
  stripeInvoiceId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  lineItems      InvoiceLineItem[]
  payments       Payment[]

  @@index([businessId, status])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String   @id @default(uuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  lineItemId  String?
  lineItem    LineItem? @relation(fields: [lineItemId], references: [id])
  description String
  quantity    Float    @default(1)
  unit        String   @default("ea")
  unitPrice   Float    @default(0)
  totalPrice  Float    @default(0)
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  @@map("invoice_line_items")
}

model Payment {
  id                String        @id @default(uuid())
  invoiceId         String
  invoice           Invoice       @relation(fields: [invoiceId], references: [id])
  amount            Float
  method            PaymentMethod @default(CARD)
  stripePaymentId   String?
  stripeReceiptUrl  String?
  notes             String?
  paidAt            DateTime      @default(now())
  createdAt         DateTime      @default(now())

  @@index([invoiceId])
  @@map("payments")
}

// ─── Materials ────────────────────────────────────────────────────────────────

model Material {
  id            String        @id @default(uuid())
  businessId    String
  business      Business      @relation(fields: [businessId], references: [id])
  name          String
  brand         String?
  productCode   String?
  coatingSystem CoatingSystem?
  costPerUnit   Float         // cost per gallon (or unit)
  unit          String        @default("gal")
  coverageRate  Float         // sq ft per gallon
  numCoats      Int           @default(1)
  color         String?
  supplier      String?
  supplierUrl   String?
  notes         String?
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  lineItems     LineItem[]

  @@index([businessId])
  @@map("materials")
}

// ─── Photos & Documents ──────────────────────────────────────────────────────

model Photo {
  id           String        @id @default(uuid())
  businessId   String
  jobId        String?
  job          Job?          @relation(fields: [jobId], references: [id])
  clientId     String?
  client       Client?       @relation(fields: [clientId], references: [id])
  category     PhotoCategory @default(DURING)
  s3Key        String
  url          String
  thumbnailUrl String?
  fileName     String
  mimeType     String        @default("image/jpeg")
  fileSizeBytes Int?
  latitude     Float?
  longitude    Float?
  takenAt      DateTime?
  isProposalReady Boolean   @default(false)
  caption      String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([jobId])
  @@index([clientId])
  @@map("photos")
}

model Document {
  id        String   @id @default(uuid())
  businessId String
  jobId     String?
  job       Job?     @relation(fields: [jobId], references: [id])
  name      String
  type      String   // "signed_quote", "invoice", "warranty", "permit", "other"
  s3Key     String
  url       String
  mimeType  String   @default("application/pdf")
  fileSize  Int?
  createdAt DateTime @default(now())

  @@index([jobId])
  @@map("documents")
}

// ─── Templates ───────────────────────────────────────────────────────────────

model Template {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  name       String
  type       String   // "quote", "proposal", "email", "sms"
  content    String   @db.Text
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  quotes     Quote[]
  bids       Bid[]

  @@map("templates")
}

// ─── Activity & Audit ────────────────────────────────────────────────────────

model ActivityLog {
  id         String   @id @default(uuid())
  businessId String
  userId     String?
  clientId   String?
  client     Client?  @relation(fields: [clientId], references: [id])
  action     String   // "quote_sent", "job_created", "payment_received", etc.
  entityType String?  // "Quote", "Job", "Invoice", etc.
  entityId   String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([businessId])
  @@index([clientId])
  @@map("activity_logs")
}

// ─── Audit Log (security & compliance trail) ──────────────────────────────────

model AuditLog {
  id         String   @id @default(uuid())
  businessId String
  userId     String?  // Who performed the action
  action     String   // "CREATE" | "UPDATE" | "DELETE" | "LOGIN" | "EXPORT" | etc.
  resource   String   // "Bid" | "Job" | "Invoice" | "User" | "Payment" | etc.
  resourceId String?  // ID of the affected record
  oldValues  Json?    // Snapshot before change
  newValues  Json?    // Snapshot after change
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([businessId])
  @@index([resource, resourceId])
  @@index([userId])
  @@map("audit_logs")
}

model Notification {
  id         String   @id @default(uuid())
  businessId String
  userId     String
  title      String
  body       String
  type       String   // "invoice_overdue", "quote_viewed", "payment_received", etc.
  entityType String?
  entityId   String?
  isRead     Boolean  @default(false)
  readAt     DateTime?
  sentAt     DateTime?
  createdAt  DateTime @default(now())

  @@index([userId, isRead])
  @@map("notifications")
}
